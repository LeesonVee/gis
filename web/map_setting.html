<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="css/element.css">
    <!-- 引入组件库 -->
    <script type="text/javascript" src="js/vue.min.js"></script>
    <script src="js/element.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" type="text/css">
    <script src="js/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="js/ajaxrequestasync.js"></script>
    <script type="text/javascript" src="js/ajaxrequestsync.js"></script>
    <script type="text/javascript" src="js/config.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/ol.css" type="text/css">
    <script src="js/ol.js"></script>
    <script src="js/map.js"></script>
    <style>
        #app {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background-color: #000;*/
        }
        .el-container{
            width:100%;
            height:100%;
        }
        .my-el-main{
            color:#333;
            text-align:center;
            width:100%;
            height:100%;
            padding: 0px;
            margin: 0px;
        }

        .el-footer {
            background-color: #B3C0D1;
            color: #333;
            text-align: center;
            line-height: 60px;
        }
        .el-header {
            background-color: #B3C0D1;
            color: #333;
            line-height: 60px;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container>
        <el-main class="my-el-main">
            <div :id="form.target" style="width: 100%;height: 100%;"></div>
        </el-main>
        <el-aside width="400px">
            <el-container>
                <el-main class="my-el-main">
                    <el-form ref="form" :model="form" :rules="rules" label-width="100px" style="margin: 10px 2px 0px 0px;">
                        <el-tabs v-model="activeName">
                            <el-tab-pane label="基础设置" name="systemBase">
                                <el-form-item label="地图名称" prop="name">
                                    <el-input v-model="form.name"></el-input>
                                </el-form-item>
                                <el-form-item label="渲染元素" prop="target">
                                    <el-input v-model="form.target" @change="targetChange" onkeyup="this.value=this.value.replace(/[^\w\.\/]/ig,'');"></el-input>
                                </el-form-item>
                                <el-form-item label="显示级别" prop="levels" style="text-align: left;">
                                    <el-select v-model="form.levels"  placeholder="请选择最大显示级别" @change="areaCodeLevelsChange">
                                        <el-option label="省级" value="province"></el-option>
                                        <el-option label="市级" value="city"></el-option>
                                        <el-option label="区级" value="district"></el-option>
                                        <el-option label="街道" value="street"></el-option>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="行政区划" required>
                                    <div>
                                        <el-col :span="8">
                                            <el-form-item prop="province">
                                                <el-select v-model="form.province"  placeholder="请选择" @change="areaCodeChange('province')">
                                                    <!--<el-option label="广东省" value="440000"></el-option>-->
                                                    <el-option v-for="item in provinceOption" :key="item.AREA_CODE" :label="item.AREA_CODE_NAME" :value="item.AREA_CODE"></el-option>
                                                </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </div>
                                    <div v-if="form.levels!=='province'">
                                        <el-col class="line" :span="1">-</el-col>
                                        <el-col :span="7">
                                            <el-form-item prop="city">
                                                <el-select v-model="form.city"  placeholder="请选择" @change="areaCodeChange('city')">
                                                    <!--<el-option label="广州市" value="440100"></el-option>-->
                                                    <el-option v-for="item in cityOption" :key="item.AREA_CODE" :label="item.AREA_CODE_NAME" :value="item.AREA_CODE"></el-option>
                                                </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </div>
                                    <div v-if="form.levels == 'district' || form.levels == 'street'">
                                        <el-col class="line" :span="1">-</el-col>
                                        <el-col :span="7">
                                            <el-form-item prop="district">
                                                <el-select v-model="form.district" placeholder="请选择" @change="areaCodeChange('district')">
                                                    <!--<el-option label="天河区" value="440106"></el-option>-->
                                                    <el-option v-for="item in districtOption" :key="item.AREA_CODE" :label="item.AREA_CODE_NAME" :value="item.AREA_CODE"></el-option>
                                                </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </div>
                                </el-form-item>
                                <el-form-item label="中心经纬度" required>
                                    <el-col :span="11">
                                        <el-form-item prop="lng">
                                            <el-input v-model="form.lng" onkeyup="this.value=this.value.replace(/[^\d.]/g,'');"></el-input>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="2"> - </el-col>
                                    <el-col :span="11">
                                        <el-form-item prop="lat">
                                            <el-input v-model="form.lat" onkeyup="this.value=this.value.replace(/[^\d.]/g,'');"></el-input>
                                        </el-form-item>
                                    </el-col>
                                </el-form-item>
                                <el-form-item label="缩放级别" prop="zoom" style="text-align: left">
                                    <el-select v-model="form.zoom" placeholder="请选择">
                                        <el-option v-for="item in zooms" :key="item.value" :label="item.label" :value="item.value"></el-option>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="地图编码" style="text-align: left;">
                                    <el-select v-model="form.projection">
                                        <el-option label="标准编码" value="EPSG:4326"></el-option>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="离线地图" style="text-align: left;">
                                    <div>
                                        <el-col :span="24">
                                            <el-radio-group v-model="form.otherMap">
                                                <el-radio :label="0">不加载</el-radio>
                                                <el-radio :label="1">加载</el-radio>
                                            </el-radio-group>
                                        </el-col>
                                    </div>
                                    <div v-if="form.otherMap==1">
                                        <el-col :span="24">
                                            <el-form-item prop="mapType">
                                                <el-select v-model="form.mapType" placeholder="请选择">
                                                    <el-option label="高的地图" value="amap"></el-option>
                                                    <!--<el-option label="百度地图" value="baidu"></el-option>-->
                                                </el-select>
                                            </el-form-item>
                                        </el-col>
                                    </div>
                                </el-form-item>
                                <el-form-item label="添加事件" style="text-align: left;">
                                    <el-checkbox-group v-model="form.events">
                                        <el-checkbox label="singleClick" key="singleClick">单击</el-checkbox>
                                        <el-checkbox label="pointermove" key="pointermove">鼠标滑过</el-checkbox>
                                        <el-checkbox label="moveend" key="moveend">缩放</el-checkbox>
                                    </el-checkbox-group>
                                </el-form-item>
                                <el-form-item style="text-align: left;">

                                    <el-button @click="resetForm('form')">重置</el-button>
                                </el-form-item>
                            </el-tab-pane>
                            <el-tab-pane label="样式设置" name="systemStyle">
                                <el-form-item label="背景颜色" style="text-align: left;">
                                    <el-color-picker v-model="form.fillColor" show-alpha></el-color-picker>
                                </el-form-item>
                                <el-form-item label="区域颜色" style="text-align: left;">
                                    <el-color-picker v-model="form.areaColor" show-alpha></el-color-picker>
                                </el-form-item>
                                <el-form-item label="线条样式" style="text-align: left;">
                                    <el-col :span="4">
                                        <el-form-item>
                                            <el-color-picker v-model="form.areaStrokeColor" show-alpha></el-color-picker>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-form-item>
                                            <el-input-number size="small" v-model="form.areaStrokeWidth" :min="2" :max="10"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-form-item>
                            </el-tab-pane>
                            <el-tab-pane label="数据绑定" name="bindData">
                                <el-collapse v-model="activeDatas">
                                    <el-collapse-item title="标注" name="1">
                                        <el-row>
                                            <el-col :span="24">
                                                <div style="margin: 5px;text-align: left;font-size: 30px;color: #3a8ee6;">
                                                    <i title="添加" class="el-icon-circle-plus" @click="openWin('标注','新增')"></i>
                                                </div>
                                            </el-col>
                                        </el-row>
                                        <el-row>
                                            <el-table :data="marksHeadData" border style="width: 100%" size="mini" max-height="350">
                                                <el-table-column prop="MODEL_RELATION_NAME" label="名称" width="220"></el-table-column>
                                                <!--<el-table-column prop="MODEL_RELATION_TYPE" label="类别" width="80">-->
                                                    <!--<template slot-scope="scope">-->
                                                        <!--<el-tag :type="scope.row.MARKS_STYLE_TYPE === '0' ? 'primary' : 'success'" disable-transitions>{{scope.row.MARKS_STYLE_TYPE === '0'?'默认':'自定义'}}</el-tag>-->
                                                    <!--</template>-->
                                                <!--</el-table-column>-->
                                                <el-table-column label="样式设置">
                                                    <template slot-scope="scope">
                                                        <el-button @click="showMarks(scope.$index,scope.row)" type="text" size="small">显示</el-button>
                                                        <el-button @click="modifyClick(scope.$index,scope.row)" type="text" size="small">修改</el-button>
                                                        <el-button @click="delModelRelation(scope.$index,scope.row)" type="text" size="small">删除</el-button>
                                                    </template>
                                                </el-table-column>
                                            </el-table>

                                        </el-row>
                                    </el-collapse-item>
                                    <el-collapse-item title="热力图" name="2">
                                        <el-row>
                                            <el-col :span="24">
                                                <div style="margin: 5px;text-align: left;font-size: 30px;color: #3a8ee6;">
                                                    <i title="添加" class="el-icon-circle-plus" @click="openWin('热地图','新增')"></i>
                                                </div>
                                            </el-col>
                                        </el-row>
                                    </el-collapse-item>
                                </el-collapse>
                            </el-tab-pane>
                        </el-tabs>
                    </el-form>
                </el-main>
                <el-footer>
                    <el-form label-width="100px">
                        <el-button type="primary" @click="submitForm('form','create')">创建地图</el-button>
                        <el-button type="success" @click="submitForm('form','save')">保存地图</el-button>
                    </el-form>
                </el-footer>
            </el-container>

        </el-aside>
    </el-container>

    <el-dialog :title="dialogDataOperate+title" :visible.sync="dialogDatabing" width="50%">
        <el-container style="height: 500px; border: 1px solid #eee;">
            <el-aside width="300px" style="background-color: rgb(238, 241, 246)">
                <el-collapse v-model="activeDataModel">
                    <el-collapse-item v-for="(item,index) in modelData" :name="index">
                        <template slot="title">
                            <div style="font-weight: bold;margin-left: 15px;">{{item.DNAME}}</div>
                        </template>
                        <el-row v-for="childItem in item.CHILD">
                            <el-col :span="1">&nbsp;</el-col>
                            <el-col :span="22"><el-radio v-model="modelRadio" :label="childItem.MID" @change="modelChange(childItem.MID,childItem.EN_NAME)">{{childItem.MNAME}}</el-radio></el-col>
                            <el-col :span="1">&nbsp;</el-col>
                            <el-col :span="24">&nbsp;</el-col>
                        </el-row>
                    </el-collapse-item>
                </el-collapse>
            </el-aside>

            <el-container>
                <el-header style="text-align: left; font-size: 12px">
                    <span>表单信息</span>
                </el-header>

                <el-main>
                    <el-form ref="formMarks" :model="formMarks" :rules="dialogRules" label-width="90px" v-if="modelRadio!=''">
                        <el-form-item :label="title+'名称'" prop="name">
                            <el-col :span="12"><el-input v-model="formMarks.name" autocomplete="off"></el-input></el-col>
                            <el-col :span="2">&nbsp;</el-col>
                            <el-col :span="10"><el-switch v-model="formMarks.displayNameStatus" active-color="#13ce66" inactive-color="#ff4949" active-text="显示" inactive-text="不显示"></el-switch></el-col>
                        </el-form-item>
                        <el-form-item label="地址绑定" prop="addressCol">
                            <el-select v-model="formMarks.addressCol" placeholder="请选择字段">
                                <el-option v-for="item in dimensionColList" :key="item.COLUMN_NAME" :label="item.COLUMN_RENAME" :value="item.COLUMN_NAME"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="地理位置" prop="coordCol">
                            <el-select v-model="formMarks.coordCol" placeholder="请选择字段">
                                <el-option v-for="item in dimensionColList" :key="item.COLUMN_NAME" :label="item.COLUMN_RENAME" :value="item.COLUMN_NAME"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="值绑定" prop="valCol">
                            <el-select v-model="formMarks.valCol" placeholder="请选择字段">
                                <el-option v-for="item in metricColList" :key="item.COLUMN_NAME" :label="item.COLUMN_RENAME" :value="item.COLUMN_NAME"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="样式选择">
                            <el-radio-group v-model="formMarks.styleType">
                                <el-radio :label="0">默认</el-radio>
                                <el-radio :label="1">自定义</el-radio>
                            </el-radio-group>
                        </el-form-item>
                        <div v-if="formMarks.styleType=='1'">
                            <el-form-item label="显示方式">
                                <el-radio-group v-model="formMarks.iconStatus" @change="changeIconRadio">
                                    <el-radio :label="0">默认圆点</el-radio>
                                    <el-radio :label="1">图标</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <div v-if="formMarks.iconStatus=='0'" style="text-align: left;">
                                <el-form-item label="原点大小">
                                    <el-input-number v-model="formMarks.radius" :min="1" :max="100"></el-input-number>
                                </el-form-item>
                                <el-form-item label="原点颜色">
                                    <el-color-picker v-model="formMarks.imageColor"></el-color-picker>
                                </el-form-item>
                                <el-form-item label="文字颜色">
                                    <el-color-picker v-model="formMarks.textFillColor"></el-color-picker>
                                </el-form-item>
                                <el-form-item label="阴影颜色">
                                    <el-color-picker v-model="formMarks.textStrokeColor"></el-color-picker>
                                </el-form-item>
                                <el-form-item label="阴影大小">
                                    <el-input-number v-model="formMarks.textStrokeWidth" :min="1" :max="10"></el-input-number>
                                </el-form-item>
                            </div>
                            <div v-else style="text-align: left;">
                                <el-form-item label="图标清单" prop="iconData">
                                    <el-select v-model="formMarks.iconData" placeholder="请选择图标" @change="iconChangeData">
                                        <el-option v-for="(item,index) in iconList" :key="index" :label="item.iconNameCn" :value="index"></el-option>
                                        <!--<el-option label="区域一" value="shanghai"></el-option>-->
                                        <!--<el-option label="区域二" value="beijing"></el-option>-->
                                    </el-select>
                                </el-form-item>
                            </div>
                        </div>
                    </el-form>
                </el-main>
            </el-container>
        </el-container>
        <div slot="footer" class="dialog-footer">
            <el-button @click="dialogDatabing = false">取 消</el-button>
            <el-button type="primary" @click="submitDialogForm('formMarks')">确 定</el-button>
        </div>
    </el-dialog>
</div>
<script type="text/javascript">
    //天河
//    var apiRootPath='http://10.195.237.115:8120/hub/';
//    var path = 'http://10.195.237.116:8140/gis/';
//    var apiRootPath='http://10.32.0.169:8120/hub/';
//    var path = 'http://10.32.0.169:8140/gis/';
    new Vue({
        el: '#app',
        data:{
            dialogDataOperate:'',
            dialogDatabing:false,
            activeDataModel:[],
            modelRadio:'',
            modelRadioEnName:'',
            modelData:[
//                {
//                    DID: "E30CF47A9B1F49EE8AA4CFD403A452C6",
//                    DNAME: "HCMS_HUB",
//                    CHILD:[{
//                        COMMENTS: "ZSRK_LRCSPM",
//                        DID: "E30CF47A9B1F49EE8AA4CFD403A452C6",
//                        DNAME: "HCMS_HUB",
//                        EN_NAME: "ZSRK_LRCSPM",
//                        MID: "7ac1dcba0b2e4824b3d1",
//                        MNAME: "ZSRK_LRCSPM（中山人口_流入城市排名）"
//                    },{
//                        COMMENTS: "ZSRK_LRCSPM1",
//                        DID: "E30CF47A9B1F49EE8AA4CFD403A452C6",
//                        DNAME: "HCMS_HUB",
//                        EN_NAME: "ZSRK_LRCSPM",
//                        MID: "7ac1dcba0b2e4824b3d123",
//                        MNAME: "ZSRK_LRCSPM（中山人口）"
//                    }
//                    ]
//                }
            ],
            dimensionColList:[],
            metricColList:[],
            iconList:[],
            formLabelWidth: '120px',
            pkey:'',
            activeName:'systemBase',
            activeDatas:['1'],
            marksHeadData:[],
            hotMapData:[],
            title:'标注',
            dialogFormVisible:false,
            formMarks:{
                name:'',
                displayNameStatus:true,
                addressCol:'',
                coordCol:'',
                valCol:'',
                styleType:0,
                status:'1',
                iconStatus:0,
                opacity:0.7,
                iconData:'',
                iconName:'',
                iconType:'',
                radius:4,
                imageColor:'#3392F4',
                textAlign:'center',
                textBaseline:'middle',
                font:'normal 14px 微软雅黑',
                text:'',
                textFillColor:'#FDF9FE',
                textStrokeColor:'#ffcc33',
                textStrokeWidth:2,
                status:'1',
                opt:'add',
                MODEL_RELATION_ID:''
            },
            dialogRules:{
                name: [
                    { required: true, message: '请输入名称', trigger: 'blur' },
                    { min: 3, max: 15, message: '长度在 3 到 15 个字符', trigger: 'blur' }
                ],
                addressCol:[
                    { required: true, message: '请选择地址', trigger: 'change' }
                ],
                coordCol:[
                    { required: true, message: '请选择地理位置', trigger: 'change' }
                ],
                valCol:[
                    { required: true, message: '请选择值', trigger: 'change' }
                ],
                iconName:[
                    { required: true, message: '请选择图标', trigger: 'change' }
                ]
            },
            modifyIndex:-1,
            form:{
                name:'',
                target:'map',
                levels:'district',
                province:'',
                city:'',
                district:'',
                lng:'',
//                lng:'113.335367',
//                lat:'23.13559',
                lat:'',
                zoom:'',
                projection:'EPSG:4326',
                otherMap:0,
                mapType:'amap',
                fillColor:'rgba(0, 0, 0, 0)',
                strokeColor:'#080107',
                areaColor:'rgba(17, 30, 88, 0)',
                areaStrokeColor:'rgba(67, 231, 249, 1)',
                areaStrokeWidth:2,
                events:[]
            },
            rules:{
                name: [
                    { required: true, message: '请输入地图名称', trigger: 'blur' },
                    { min: 3, max: 15, message: '长度在 3 到 15 个字符', trigger: 'blur' }
                ],
                target:[
                    { required: true, message: '渲染元素不能为空', trigger: 'change' }
                ],
                levels:[
                    { required: true, message: '显示级别不能为空', trigger: 'change' }
                ],
                province:[
                    { required: true, message: '省级不能为空', trigger: 'change' }
                ],
                city:[
                    { required: true, message: '市级不能为空', trigger: 'change' }
                ],
                district:[
                    { required: true, message: '区级不能为空', trigger: 'change' }
                ],
                lng:[
                    { required: true, message: '经度不能为空', trigger: 'change' }
                ],
                lat:[
                    { required: true, message: '纬度不能为空', trigger: 'change' }
                ],
                zoom:[
                    { required: true, message: '缩放级别不能为空', trigger: 'change' }
                ]
            },
            zooms:[
                {value:1,label:'1级'},
                {value:2,label:'2级'},
                {value:3,label:'3级'},
                {value:4,label:'4级'},
                {value:5,label:'5级'},
                {value:6,label:'6级'},
                {value:7,label:'7级'},
                {value:8,label:'8级'},
                {value:9,label:'9级'},
                {value:10,label:'10级'},
                {value:11,label:'11级'},
                {value:12,label:'12级'},
                {value:12.5,label:'12.5级'},
                {value:13,label:'13级'},
                {value:14,label:'14级'},
                {value:15,label:'15级'},
                {value:16,label:'16级'},
                {value:17,label:'17级'},
                {value:18,label:'18级'},
                {value:19,label:'19级'},
                {value:20,label:'20级'}
            ],
            mapCfgs:{
                baseInfo:{},
                styleInfo:{}
            },
            showMap:false,
            areaCodes:[],
            provinces:[],
            provinceOption:[],
            citys:[],
            cityOption:[],
            districts:[],
            districtOption:[]
        },
        created(){
            this.loadParam();
        },
        methods:{
            targetChange:function(val){
                $('#'+val).html('');
            },
            submitForm:function(formName,type) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.getMapCfgs();
                        var cfgs = this.mapCfgs.baseInfo;
                        for(var p in this.mapCfgs.styleInfo){
                            cfgs[p] = this.mapCfgs.styleInfo[p];
                        }
                        if(type=='create'){
                            initMap(cfgs);
                            this.showMap = true;
                        }else if(type='save'){
                            if(!this.showMap){
                                initMap(cfgs);
                            }
                            var params = this.mapCfgs;
                            params['name'] = this.form.name;
                            if(this.pkey!=''){
                                params['id'] = this.pkey;
                            }
                            this.saveGisData('POST',apiRootPath+'map/saveMapData.html',params);
                        }
                    } else {
                        if(this.activeName=='systemStyle' || this.activeName=='bindData'){
                            this.myMessage('请完善【基础设置】数据','error');
                        }
                        return false;
                    }
                });
            },
            resetForm:function(formName) {
                this.$refs[formName].resetFields();
                this.form.otherMap=0;
                this.form.events=[];
                this.resetMapCfgs();
            },
            getMapCfgs:function(){
                this.resetMapCfgs();
                var form = this.form;
                this.mapCfgs.baseInfo['name']=form.name;
                this.mapCfgs.baseInfo['target']=form.target;
                this.mapCfgs.baseInfo['center']=[form.lng,form.lat];
                this.mapCfgs.baseInfo['zoom']=form.zoom;
                this.mapCfgs.baseInfo['projection']=form.projection;
                this.mapCfgs.baseInfo['levels']=form.levels;
                if(form.levels=='province'){
                    this.mapCfgs.baseInfo['upAreaCode']='100000';
                    this.mapCfgs.baseInfo['areaCode']=form.province;
                }else if(form.levels=='city'){
                    this.mapCfgs.baseInfo['upAreaCode']=form.province;
                    this.mapCfgs.baseInfo['areaCode']=form.city;
                }else if(form.levels=='district'){
                    this.mapCfgs.baseInfo['upAreaCode']=form.city;
                    this.mapCfgs.baseInfo['areaCode']=form.district;
                }else if(form.levels=='street'){
                    this.mapCfgs.baseInfo['upAreaCode']=form.city+'-1';
                    this.mapCfgs.baseInfo['areaCode']=form.district+'-1';
                }
                if(form.otherMap=='1'){
                    this.mapCfgs.baseInfo['otherMap']=form.otherMap;
                    this.mapCfgs.baseInfo['mapType']=form.mapType;
                }
                this.mapCfgs.baseInfo['events']=form.events;
                this.mapCfgs.styleInfo['fillColor']=form.fillColor;
                this.mapCfgs.styleInfo['areaColor']=form.areaColor;
                this.mapCfgs.styleInfo['areaStrokeColor']=form.areaStrokeColor;
                this.mapCfgs.styleInfo['areaStrokeWidth']=form.areaStrokeWidth;
            },
            resetMapCfgs:function(){
                $('#'+this.form.target).html('');
                this.mapCfgs.baseInfo={};
                this.mapCfgs.styleInfo={};
            },
            rquestParams:function(method,api,data){
                var jsonDataList={
                    httpMethod:method,
                    url:api,
                    data:data?JSON.stringify(data):''
                };
                return jsonDataList;
            },
            saveGisData:function(method,api,data){
                var me = this;
                var jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200'){
                        me.pkey = json.body;
                        me.myMessage('恭喜您，保存成功!','success');
                        me.createHtmlTemplet();
                    }else{
                        me.myMessage('保存失败，请稍后再试!','error');
                    }
                });
            },
            /**
             * msg：提示信息
             * type：消息类型：success：成功；error：错误；warning：警告；
             * */
            myMessage:function(msg,type) {
                this.$message({
                    message: msg,
                    type: type
                });
            },
            createHtmlTemplet:function(){
                var html='<!DOCTYPE html>'
                              +'<html lang="en">'
                              +'<head>'
                              +'    <meta charset="UTF-8">'
                              +'    <title>GIS</title>'
                              +'    <link rel="stylesheet" href="../css/bootstrap.css" type="text/css">'
                              +'    <link rel="stylesheet" href="../css/ol.css" type="text/css">'
                              +'    <script type="text/javascript" src="../js/ajaxrequestasync.js"></s'+ 'cript>'
                              +'    <script type="text/javascript" src="../js/ajaxrequestsync.js"></s'+ 'cript>'
                              +'    <script src="../js/jquery-2.2.3.min.js"></s'+ 'cript>'
                              +'    <script src="../js/bootstrap.js"></s'+ 'cript>'
                              +'    <script src="../js/ol.js"></s'+ 'cript>'
                              +'    <script src="../js/map.js"></s'+ 'cript>'
                              +'    <style type="text/css">head,html,body{width: 100%;height: 100%;}</style>'
                              +'</head>'
                              +'<body>'
                              +'    <div id="map" style="width: 100%;height: 100%;"></div>'
                              +'<script type="text/javascript">'
                              +'    var apiRootPath="'+apiRootPath+'";'
                              +'    var path = "'+path+'";'
                              +'    var jsonDataList ={httpMethod:"POST",url:"'+apiRootPath+'map/getMapByPkey.html",data:JSON.stringify({ID:"2805a1559c8c42caaa7f"})};'
                              +'    ajaxrequestasync(jsonDataList,function(code,msg,json){if(code=="200"){var body = json.body;var baseInfo = JSON.parse(body.BASE_INFO);var styleInfo = JSON.parse(body.STYLE_INFO);var cfgs = baseInfo;for(var p in styleInfo){cfgs[p] = styleInfo[p];}initMap(cfgs);}});'
                              +'</s'+'cript>'
                              +'</body>'
                              +'</html>';
                html=html.replace(/%/g,'%25');//将百分号转义
                var fileName='GIS_'+this.pkey;
                var fileType="html";
                var fileInfor={
                    fileName:fileName,
                    fileType:fileType,
                    data:html,
                }
                var fileJsonData=this.rquestParams('POST',configpre.map_createFile,fileInfor);
                var me = this;
                ajaxrequestasync(fileJsonData,function(code,msg,json){
                    if(code=='200'){
                        var templateUrl=json.body;
                        me.$alert('保存成功，模板路径：'+templateUrl, '提示', {
                            confirmButtonText: '确定',
                        });
                    }else{
                        me.$message({
                            showClose: true,
                            type: 'error',
                            message: '模板文件生成失败！',
                            duration:1500
                        });
                    }
                })
            },
            loadParam:function(){
                //加载行政区划数据
                this.loadAreaCode('POST',configpre.map_loadAreaCodeData);
                //加载标注数据
                this.loadModelRelationData('POST',configpre.map_loadModelRelation);
                //
                this.loadModelData('POST',configpre.api_loadModelDataWithLayout);
            },
            initDialogParam:function(init){
                if(init){
                    this.modelRadio='';
                    this.modelRadioEnName = '';
                }
                this.modifyIndex=-1;
                this.dimensionColList=[];
                this.metricColList=[];
                this.formMarks.name='';
                this.formMarks.displayNameStatus=true;
                this.formMarks.addressCol='';
                this.formMarks.coordCol='';
                this.formMarks.valCol='';
                this.formMarks.styleType=0;
                this.formMarks.status='1';
                this.formMarks.iconStatus=0;
                this.formMarks.opacity=0.7;
                this.formMarks.iconData='';
                this.formMarks.iconName='disease';
                this.formMarks.iconType='jpg';
                this.formMarks.radius=4;
                this.formMarks.imageColor='#3392F4';
                this.formMarks.textAlign='center';
                this.formMarks.textBaseline='middle';
                this.formMarks.font='normal 14px 微软雅黑';
                this.formMarks.text='';
                this.formMarks.textFillColor='#FDF9FE';
                this.formMarks.textStrokeColor='#ffcc33';
                this.formMarks.textStrokeWidth=2;
            },
            loadAreaCode:function(method,api,data){
                var me = this;
                var jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200' && json.body){
                        me.provinces = json.body.provinces;
                        me.provinceOption = json.body.provinces;
                        me.citys = json.body.citys;
                        me.districts = json.body.districts;
                    }
                });
            },
            loadModelRelationData:function(method,api,data){
                var me = this;
                var jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200' && json.body){
                       me.marksHeadData = json.body.markList||[];
                       me.hotMapData = json.body.hotMapList||[];
                    }
                });
            },
            loadModelData:function(method,api,data){
                var me = this;
                var jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200' && json.body){
                        me.modelData = json.body;
                        for(let i=0,length=me.modelData.length;i<length;i++){
                            me.activeDataModel.push(i);
                        }
                    }
                });
            },
            saveMarksData:function(data,index){
                let me = this;
                let type = this.formMarks.opt;
                let dataType = data.MODEL_RELATION_TYPE;
                let jsonDataList = this.rquestParams('POST',configpre.map_saveModelRelation,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200'){
                        let msg = '修改成功';
                        if(type=='delete'){
                            msg="删除成功";
                            if(dataType=='1'){
                                me.marksHeadData.splice(index,1);
                            }else if(dataType=='2'){
                                me.hotMapData.splice(index,1);
                            }
                        }else if(type=='add'){
                            msg="添加成功";
                            data.MODEL_RELATION_ID=json.body;
                            if(dataType=='1'){
                                me.marksHeadData.push(data);
                            }else if(dataType=='2'){
                                me.hotMapData.push(data);
                            }
                        }else if(type=='modify'){
                            msg = '修改成功';
                            if(dataType=='1'){
                                me.marksHeadData.splice(index,1,data);
                            }else if(dataType=='2'){
                                me.hotMapData.splice(index,1,data);
                            }
                        }
                        me.myMessage(msg,'success');
                    }else{
                        me.myMessage('操作失败','error');
                    }
                });
            },
            areaCodeChange:function(type){
                if(type=='province'){
                    this.form.city = '';
                    this.form.district = '';
                    this.cityOption=[];
                    this.districtOption=[];
                    this.citys.forEach(city=>{
                        if(city.AREA_CODE_PARENT==this.form.province){
                            this.cityOption.push(city);
                        }
                    });
                }else if(type=='city'){
                    this.form.district = '';
                    this.districtOption=[];
                    this.districts.forEach(district=>{
                        if(district.AREA_CODE_PARENT==this.form.city){
                            this.districtOption.push(district);
                        }
                    });
                }
                if(this.form.levels==type || (this.form.levels=='street' && type=='district')){
                    this.setMapCenter(type);
                }
            },
            areaCodeLevelsChange:function(val){
                this.form.lng = '';
                this.form.lat = '';
                this.setMapCenter(val);
            },
            setMapCenter:function(type){
                var data=[];
                var areaCode;
                if(type=='province'){
                    data = this.provinceOption;
                    areaCode = this.form.province;
                }else if(type=='city'){
                    data = this.cityOption;
                    areaCode = this.form.city;
                }else if(type=='district' || type=='street'){
                    data = this.districtOption;
                    areaCode = this.form.district;
                }
                data.forEach(item=>{
                    if(item.AREA_CODE==areaCode){
                        this.form.lng = item.LNG;
                        this.form.lat = item.LAT;
                    }
                });
            },
            openWin:function(dataType,optType,row){
                if(!this.showMap){
                    this.myMessage('请先创建地图','warning');
                    return;
                }
                this.dialogDatabing = true;
                this.dialogDataOperate = optType;
                this.title = dataType;
                this.formMarks.status='1';
                if(optType=='新增'){
                    this.initDialogParam(true);
                    this.formMarks.opt='add';
                }else if(optType=='修改'){
                    let params = {
                        MODEL_ID: row.MODEL_ID,
                        TABLE_NAME: row.TABLE_NAME
                    };
                    this.loadModelColumnData('POST',configpre.api_loadColsByTableNameAndModleId,params);
                    this.modelRadio = row.MODEL_ID;
                    this.formMarks.name=row.MODEL_RELATION_NAME;
                    this.formMarks.addressCol=row.RELATION_DIM_ADDRESS;
                    this.formMarks.coordCol=row.RELATION_DIM_COOR;
                    this.formMarks.valCol=row.RELATION_MEASURE_VAL;
                    this.formMarks.opt='modify';
                    this.formMarks.MODEL_RELATION_ID=row.MODEL_RELATION_ID;
                    var styleData = row.MODEL_STYLE_DATA;
                    if(typeof(row.MODEL_STYLE_DATA) == "string"){
                        styleData = JSON.parse(row.MODEL_STYLE_DATA);
                    }
                    for(var p in styleData){
                        this.formMarks[p] = styleData[p];
                    }
                }
            },
            openAddMarksWin:function(){
//                this.dialogFormVisible = true;
                this.dialogDatabing = true;
            },
            saveDialogData:function(index){
                let data ={};
                let formMarks = this.formMarks;
                let marksStyleData = {};
                marksStyleData['iconStatus'] = formMarks.iconStatus;
                marksStyleData['opacity'] = formMarks.opacity;
                marksStyleData['iconName'] = formMarks.iconName;
                marksStyleData['iconType'] = formMarks.iconType;
                marksStyleData['radius'] = formMarks.radius;
                marksStyleData['imageColor'] = formMarks.imageColor;
                marksStyleData['textAlign'] = formMarks.textAlign;
                marksStyleData['textBaseline'] = formMarks.textBaseline;
                marksStyleData['font'] = formMarks.font;
                marksStyleData['text'] = formMarks.name;
                marksStyleData['textFillColor'] = formMarks.textFillColor;
                marksStyleData['textStrokeColor'] = formMarks.textStrokeColor;
                marksStyleData['textStrokeWidth'] = formMarks.textStrokeWidth;
                marksStyleData['styleType'] = formMarks.styleType;
                marksStyleData['displayNameStatus'] = formMarks.displayNameStatus;
                data['MODEL_RELATION_NAME']=formMarks.name;
                if(this.title=='标注'){
                    data['MODEL_RELATION_TYPE']='1';
                }else if(this.title=='热力图'){
                    data['MODEL_RELATION_TYPE']='2';
                }
                if(formMarks.opt=='modify'){
                    data['MODEL_RELATION_ID'] = formMarks.MODEL_RELATION_ID;
                }
                data['STATUS'] = formMarks.status;
                data['MODEL_ID']=this.modelRadio;
                data['TABLE_NAME']=this.modelRadioEnName;
                data['RELATION_DIM_COOR']=formMarks.coordCol;
                data['RELATION_DIM_ADDRESS']=formMarks.addressCol;
                data['RELATION_MEASURE_VAL']=formMarks.valCol;
                data['MODEL_STYLE_DATA']=marksStyleData;
                this.saveMarksData(data,index);
            },
            modifyClick:function(index, row){
                this.modifyIndex=index;
                this.modelRadioEnName = row.TABLE_NAME;
                this.openWin('标注','修改',row);
            },
            showMarks:function(index,row){
//                if(!this.showMap){
//                    this.myMessage('请先创建地图','warning');
//                    return;
//                }
                var params = {modelRelation:[row]};
                this.loadTableData('POST',configpre.map_queryTableDataByGisModelRelation,params);
            },
            delModelRelation:function(index,row){
                row['STATUS'] ='0';
                this.formMarks.opt='delete';
                this.saveMarksData(row,index);
            },
            modelChange:function(modelId,tableName){
                this.initDialogParam();
                this.modelRadioEnName = tableName;
                let params = {
                    MODEL_ID: modelId,
                    TABLE_NAME: tableName
                };
                this.loadModelColumnData('POST',configpre.api_loadColsByTableNameAndModleId,params);
            },
            loadModelColumnData:function(method,api,data){
                let me = this;
                let jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200' && json.body){
                        let body = json.body;
                        me.dimensionColList = body.dimensionColList;
                        me.metricColList = body.metricColList;
                    }
                });
            },
            loadTableData:function(method,api,data){
                let jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200' && json.body){
                        let body = json.body;
                        cleanMarks();
                        body.forEach(item=>{
                            let cfgs = item.style;
                            if(typeof(cfgs)=='string'){
                                cfgs = JSON.parse(item.style);
                            }
                            let datas = item.data;
                            datas.forEach(data=>{
                                debugger;
                                let coords = eval(data.COORDS);
                                cfgs['lng']=coords[0];
                                cfgs['lat']=coords[1];
                                console.info(cfgs);
                                addMarksV2(cfgs);
                            });
                        });
                    }
                });
            },
            submitDialogForm:function(formName) {
                this.$refs[formName].validate((valid) => {
                    if(valid){
                        this.saveDialogData(this.modifyIndex);
                        this.dialogDatabing = false;
                    }else{
                        return false;
                    }
                })
            },
            iconChangeData:function(index){
                debugger;
                var item = this.iconList[index];
                this.formMarks.iconName = item.iconName;
                this.formMarks.iconType = item.iconType;
            },
            changeIconRadio:function(val){
                debugger;
                if(val == '1'){
                    if(this.iconList.length==0){
                        this.loadIconData('POST',configpre.map_getGisIcon);
                    }
                }
            },
            loadIconData:function(method,api,data){
                let me = this;
                let jsonDataList = this.rquestParams(method,api,data);
                ajaxrequestasync(jsonDataList,function(code,msg,json){
                    if(code=='200'){
                        me.iconList= json.body||[];
                    }
                });
            }
        }
    });

</script>
</body>
</html>